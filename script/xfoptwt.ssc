%SCRIPT XW
% IF EXISTS 6 .NE. 1 THEN
{I  No reflections have been stored.
{I  Agreement analysis is not possible.
%   FINISH
% END IF
%%
%%
^^WI WINDOW XFOPTW 'Chebychev Weighting analysis for F' SIZE KEEP MODAL
^^WI GRID BOSS NROWS=4 NCOLS=3
^^WI {
^^WI   @ 1,2 GRID EXPL NROWS=1 NCOLS=3
^^WI   {
^^WI     @ 1,1 GRID EXP2 NROWS=1 NCOLS=3 OUTLINE=''
^^WI     {
^^WI       @ 1,1 ICON IM WARN
^^WI       @ 1,3 GRID EXP2 NROWS=3 NCOLS=1
^^WI       {
^^WI         @ 1,1 STATIC XFW1 'Do not use a calculated weighting scheme'
^^WI         @ 2,1 STATIC XFW2 'unless you are certain that your model is as'
^^WI         @ 3,1 STATIC XFW3 'correct and complete as possible!'
^^WI       }
^^WI     }
^^WI     @ 1,3 GRID EXP2 NROWS=1 NCOLS=3 OUTLINE=''
^^WI     {
^^WI       @ 1,1 ICON IM INFO
^^WI       @ 1,3 GRID EXP2 NROWS=3 NCOLS=1
^^WI       {
^^WI         @ 1,1 STATIC XFW1
^^WI 'To choose the best scheme: (1) Smooth fit (red,top), no local maxima.'
^^WI         @ 2,1 STATIC XFW2
^^WI '(2) Weighted residual (blue,bottom) should be flat and average ~= 1.0'
^^WI         @ 3,1 STATIC XFW3
^^WI '(3) Low number of outliers. (4) Favour lower number of parameters.'
^^WI       }
^^WI     }
^^WI   }
^^WI   @ 2,2 GRID GRAPHS NROWS=1 NCOLS=5
^^WI   {
^^WI     @ 1,1 GRID PAR5 NROWS=7 NCOLS=1 OUTLINE='5 parameters'
^^WI     {
^^WI       @ 1,1 PLOTWINDOW _RWGHT NROWS=20 NCOLS=48
^^WI       @ 3,1 PLOTWINDOW _VFO NROWS=20 NCOLS=48
^^WI       @ 5,1 GRID BTNS NROWS=1 NCOLS=9
^^WI       {                               
^^WI         @ 1,2 STATIC _TSWD '<w(del**2)>: '
^^WI         @ 1,4 STATIC _WDSQ '     .0   '
^^WI         @ 1,6 STATIC _TSWD 'Outliers: '
^^WI         @ 1,8 STATIC _COUT '   0   '
^^WI       }
^^WI       @ 7,1 BUTTON BTPAR5 'Use 5 parameter scheme'
^^WI     }                     
^^WI     @ 1,3 GRID PAR4 NROWS=7 NCOLS=1 OUTLINE='4 parameters'
^^WI     {
^^WI       @ 1,1 PLOTWINDOW _RWGH2 NROWS=20 NCOLS=48
^^WI       @ 3,1 PLOTWINDOW _VF2 NROWS=20 NCOLS=48
^^WI       @ 5,1 GRID BTNS NROWS=1 NCOLS=9
^^WI       {                               
^^WI         @ 1,2 STATIC _TSWD '<w(del**2)>: '
^^WI         @ 1,4 STATIC _WDS2 '     .0   '
^^WI         @ 1,6 STATIC _TSWD 'Outliers: '
^^WI         @ 1,8 STATIC _COU2 '   0   '
^^WI       }
^^WI       @ 7,1 BUTTON BTPAR4 'Use 4 parameter scheme'
^^WI      }
^^WI     @ 1,5 GRID PAR3 NROWS=7 NCOLS=1 OUTLINE='3 parameters'
^^WI     {
^^WI       @ 1,1 PLOTWINDOW _RWGH3 NROWS=20 NCOLS=48
^^WI       @ 3,1 PLOTWINDOW _VF3 NROWS=20 NCOLS=48
^^WI       @ 5,1 GRID BTNS NROWS=1 NCOLS=9
^^WI       {                               
^^WI         @ 1,2 STATIC _TSWD '<w(del**2)>: '
^^WI         @ 1,4 STATIC _WDS3 '     .0   '
^^WI         @ 1,6 STATIC _TSWD 'Outliers: '
^^WI         @ 1,8 STATIC _COU3 '   0   '
^^WI       }
^^WI       @ 7,1 BUTTON BTPAR3 'Use 3 parameter scheme' COMMIT DEFAULT
^^WI     }
^^WI   }
^^WI   @ 3,2 GRID STUFF NROWS=1 NCOLS=5
^^WI   {
^^WI     @ 1,1 STRETCH XWS HORIZONTAL
^^WI     @ 1,2 BUTTON XWHELP '&Help'
^^WI     @ 1,4 BUTTON XWCLOSE '&Cancel (use unit weights)' CANCEL 
^^WI   }
^^WI }
^^WI SHOW
^^CR
%%
%% Calculate the six graphs:
%%
%% NB output graphs from 'list 4' is always to _RWGHT and output from
%% 'analyse' is always to _VFO, therefore change names of plotwindows
%% in between each command to get the six separate graphs.
%%
{S * Chebychev weighting with 5 parameters
{I   Estimated delta(F)**2 as a function of F:
%          COPY '#LIST 4'
%          COPY 'SCHEME NUMBER=14, NPARAM=5'
%          COPY 'END'
%          COPY '#WEIGHT'
%          COPY 'GUI GRAPH=ON OUTL=ON'
%          COPY 'END'
%          COPY '#ANALYSE'
%          COPY 'LIST LEVEL=HIGH'
%          COPY 'PLOTFO DELTA ON WDELSQ'
{I   Agreement analysis:
%          COPY 'END'
^^CO RENAME _VFO _VF1      RENAME _VF2 _VFO
^^CO RENAME _RWGHT _RWGH1  RENAME _RWGH2 _RWGHT
^^CO RENAME _COUT _COU1  RENAME _COU2 _COUT
^^CO RENAME _WDSQ _WDS1  RENAME _WDS2 _WDSQ
{S * Chebychev weighting with 4 parameters
{I   Estimated delta(F)**2 as a function of F:
%          COPY '#LIST 4'
%          COPY 'SCHEME NUMBER=14, NPARAM=4'
%          COPY 'END'
%          COPY '#WEIGHT'
%          COPY 'GUI GRAPH=ON OUTL=ON'
%          COPY 'END'
%          COPY '#ANALYSE'
%          COPY 'LIST LEVEL=HIGH'
%          COPY 'PLOTFO DELTA OFF WDELSQ'
{I   Agreement analysis:
%          COPY 'END'
^^CO RENAME _VFO _VF2       RENAME _VF3 _VFO
^^CO RENAME _RWGHT _RWGH2   RENAME _RWGH3 _RWGHT
^^CO RENAME _COUT _COU2  RENAME _COU3 _COUT
^^CO RENAME _WDSQ _WDS2  RENAME _WDS3 _WDSQ
{S * Chebychev weighting with 3 parameters
{I   Estimated delta(F)**2 as a function of F:
%          COPY '#LIST 4'
%          COPY 'SCHEME NUMBER=14, NPARAM=3'
%          COPY 'END'
%          COPY '#WEIGHT'
%          COPY 'GUI GRAPH=ON OUTL=ON'
%          COPY 'END'
%          COPY '#ANALYSE'
%          COPY 'LIST LEVEL=HIGH'
%          COPY 'PLOTFO DELTA OFF WDELSQ'
{I   Agreement analysis:
%          COPY 'END'
%%
%%
%% Wait for the users response:
%%
%%
% LOOP
%   VERIFY XWCLOSE XWHELP BTPAR3 BTPAR4 BTPAR5
%   GET SILENT NOSTORE FINAL ABBREVIATED ' ' ' '
%%
%%
%   CASE VALUE
%     BLOCK  %CLOSE%
^^CO     DISPOSE XFOPTW
%        COPY '#LIST 4'
%        COPY 'END'
%        COPY '#WEIGHT'
%        COPY 'END'

{S * Unit weights are being used.
{I   Useful early in refinement on F - not acceptable for publication.

%        FINISH
%     END BLOCK
%     BLOCK  %HELP%
%        COPY '#SCRIPT XHELP1'

Once a model is reasonably correct (say, hydrogens placed) the values
of Fc are likely to be quite reliable. A polynomial can be fitted
through the residual of Fo-Fc to produce a weighting scheme which, if Fc
really are correct, reflects the reliability of Fo.

This analysis shows schemes using 5, 4 and 3 term polynomials, you must
decide which is best.

The top graph shows the estimated reciprocal weight against Fo. This
should roughly parallel the BLUE bars in the lower graph (an analysis
of <|Fo-Fc|> for given bins of Fo. (That is to say: where the blue bars
are high == bad agreement, thus the weight for those reflections should
be low == high reciprocal weight...)

The graph should be smoothly varying and have no pronounced local maxima -
in general it can peak at the ends of the graph, but not in the middle.

The bottom graph shows the residual itself. The blue bars are simply
<|Fo-Fc|> and the red bars are <w|Fo-Fc|>. The red bars represent the
residual after the weighting scheme has been applied, in other words, how
well the scheme manages to model the differences in Fo and Fc. The red
bars should be as close to unity as possible across the whole range of /Fo/.

%        COPY '#SCRIPT XHELP2'
%     END BLOCK
%     BLOCK                %BTPAR3%
^^CO     DISPOSE XFOPTW
%        COPY '#LIST 4'
%        COPY 'SCHEME NUMBER=14, NPARAM=3'
%        COPY 'END'
%        COPY '#WEIGHT'
%        COPY 'END'

{S * Weights are based on three-term Chebychev
{S   polynomial fitted to the residual.

%        FINISH
%     END BLOCK
%     BLOCK                %BTPAR4%
^^CO     DISPOSE XFOPTW
%        COPY '#LIST 4'
%        COPY 'SCHEME NUMBER=14, NPARAM=4'
%        COPY 'END'
%        COPY '#WEIGHT'
%        COPY 'END'

{S * Weights are based on four-term Chebychev
{S   polynomial fitted to the residual.

%        FINISH
%     END BLOCK
%     BLOCK                %BTPAR5%
^^CO     DISPOSE XFOPTW
%        COPY '#LIST 4'
%        COPY 'SCHEME NUMBER=14, NPARAM=5'
%        COPY 'END'
%        COPY '#WEIGHT'
%        COPY 'END'

{S * Weights are based on five-term Chebychev
{S   polynomial fitted to the residual.

%        FINISH
%     END BLOCK
%   END CASE
%%
%%
% END LOOP
%END SCRIPT
